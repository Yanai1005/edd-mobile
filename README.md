# AllergyGuard

日本人が海外で外食する際のアレルギー対応支援Flutterアプリです。

## 主要機能

1. **レストランメニュー撮影**: カメラまたはギャラリーから画像を選択
2. **OCRでテキスト認識**: Google ML Kitを使用してメニューのテキストを自動認識
3. **自動日本語翻訳**: 認識したテキストを日本語に翻訳
4. **画像オーバーレイ表示（NEW!）**: 翻訳されたテキストを写真上の元の位置に表示
5. **アレルギー情報照合**: 登録したアレルギー情報とメニューを照合
6. **危険な料理に警告表示**: アレルギー物質が含まれる料理に警告を表示

## アーキテクチャ

### ディレクトリ構造

```
lib/
├── main.dart                           # アプリケーションのエントリーポイント
├── models/                             # データモデル
│   ├── allergy.dart                    # アレルギー情報のモデル
│   └── menu_item.dart                  # メニューアイテムのモデル
├── providers/                          # 状態管理（Provider）
│   └── menu_scan_provider.dart         # メニュースキャンの状態管理
├── screens/                            # UI画面
│   ├── home_screen.dart                # ホーム画面
│   ├── allergy_settings_screen.dart    # アレルギー設定画面
│   └── scan_result_screen.dart         # スキャン結果画面
├── services/                           # ビジネスロジック
    ├── allergy_service.dart            # アレルギー情報管理サービス
    ├── ai_allergy_estimation_service.dart  # AI推定サービス（NEW!）
    ├── camera_service.dart             # カメラ・ギャラリー操作サービス
    ├── ocr_service.dart                # OCRサービス
    └── translation_service.dart        # 翻訳サービス
```

### 使用パッケージ

- **camera**: カメラ機能
- **image_picker**: 画像選択機能
- **google_mlkit_text_recognition**: OCR（文字認識）
- **translator**: 翻訳機能
- **google_generative_ai**: AI推定機能（Google Gemini）
- **shared_preferences**: ローカルストレージ
- **provider**: 状態管理
- **permission_handler**: 権限管理

## セットアップ

### 前提条件

- Flutter SDK 3.7.0 以上
- Android Studio または Xcode（iOSの場合）

### インストール

1. リポジトリをクローン

```bash
git clone <repository-url>
cd allergy_guard
```

2. 依存関係をインストール

```bash
flutter pub get
```

3. アプリを実行

```bash
# Android
flutter run

# iOS (Macのみ)
flutter run -d ios
```

## 使い方

### 1. アレルギー情報の設定

初回起動時に、ホーム画面の設定ボタンまたは警告メッセージから「アレルギー設定」画面に移動し、あなたのアレルギー情報を選択します。

対応アレルギー項目:
- 小麦（wheat）
- 卵（egg）
- 乳製品（milk）
- ピーナッツ（peanut）
- ナッツ類（tree nuts）
- 甲殻類（shellfish）
- 魚（fish）
- 大豆（soy）
- ゴマ（sesame）

### 2. メニューをスキャン

1. ホーム画面で「カメラで撮影」または「ギャラリーから選択」をタップ
2. レストランのメニューを撮影または選択
3. アプリが自動的に:
   - テキストを認識（OCR）
   - 日本語に翻訳
   - アレルギー物質をチェック

### 3. 結果の確認

スキャン結果画面では2つの表示モードを選択できます:

**オーバーレイ表示モード（デフォルト）**:
- 翻訳されたテキストが写真上の元の位置に直接表示されます
- アレルギー物質が検出された料理は赤色で強調表示されます
- 画像アイコンをタップしてリスト表示に切り替え可能
- 言語アイコンをタップして原文と翻訳を切り替え可能

**リスト表示モード**:
- 撮影した画像が上部に表示されます
- 各メニュー項目が原文と翻訳で一覧表示されます
- アレルギー物質が検出された料理には警告マークが表示されます
- 検出されたアレルギー物質が赤いタグで表示されます
- リストアイコンをタップしてオーバーレイ表示に切り替え可能

## 画像オーバーレイ機能について

### 概要

OCRで認識したテキストの位置情報を使用して、翻訳されたテキストを写真上の元の位置に直接表示します。これにより、メニューを見ながら直感的に料理を理解できます。

### 特徴

- **位置精度**: OCRで取得したテキストの座標に基づいて正確に配置
- **自動スケーリング**: 画像サイズに合わせてテキストを自動調整
- **警告の視覚化**: アレルギー物質が検出された料理は赤色で強調表示
- **原文/翻訳切り替え**: ボタン一つで原文と翻訳を切り替え
- **リスト表示切り替え**: 詳細情報が必要な場合はリスト表示に切り替え可能

### 使い方

1. メニューをスキャンすると、デフォルトでオーバーレイ表示されます
2. 右上の言語アイコンをタップして原文と翻訳を切り替え
3. 画像アイコンをタップしてリスト表示に切り替え
4. 赤色で表示された料理はアレルギー物質が含まれています

### 概要

従来のキーワードマッチングに加えて、Google Gemini AIを使用して料理名から含まれる可能性のあるアレルギー物質を推定する機能を追加しました。

### 動作の仕組み

1. **キーワードベース検出**: まず従来通りキーワードでアレルギー物質を検出
2. **AI推定**: 設定が有効な場合、AIが料理名を分析してアレルギー物質を推定
3. **結果の統合**: 両方の結果を組み合わせて最終的なアレルギー警告を表示

### 利点

- 料理名だけからアレルギー物質を推定可能
- 一般的な料理の材料知識に基づいた判定
- キーワードに含まれない表現でも検出可能
- より高精度なアレルギー検出

### 必要な設定

1. Google AI Studioでアカウントを作成
2. Gemini APIキーを取得
3. アプリ実行時に `--dart-define=GEMINI_API_KEY=your_key` を指定
4. アプリの設定画面で「AI推定機能を使用」をオンにする

## 技術的な特徴

### 状態管理

Providerパターンを使用して、アプリ全体の状態を効率的に管理しています。`MenuScanProvider`が以下を管理:
- スキャンした画像
- OCRで認識したテキスト
- 翻訳結果
- アレルギーチェック結果
- ローディング状態
- エラーメッセージ

### サービス層

ビジネスロジックをサービス層に分離し、保守性と再利用性を向上:
- `AllergyService`: アレルギー情報の管理とチェック
- `CameraService`: カメラとギャラリーの操作
- `OcrService`: Google ML Kitを使用したOCR処理（位置情報付き）
- `TranslationService`: Google翻訳APIを使用した翻訳

### ローカルストレージ

`SharedPreferences`を使用して、ユーザーのアレルギー情報を端末に保存します。

## 権限

### Android

以下の権限が必要です（AndroidManifest.xmlに設定済み）:
- `CAMERA`: カメラ使用
- `READ_EXTERNAL_STORAGE`: ギャラリーから画像を読み込み
- `WRITE_EXTERNAL_STORAGE`: 画像を保存（Android 12以下）
- `INTERNET`: 翻訳API通信

### iOS

Info.plistに以下のキーが必要です:
- `NSCameraUsageDescription`: カメラ使用の説明
- `NSPhotoLibraryUsageDescription`: フォトライブラリアクセスの説明

## 今後の拡張予定

- [x] 画像オーバーレイ表示
- [ ] AI推定機能（Google Gemini）
- [ ] オフライン翻訳機能
- [ ] より多くのアレルギー項目のサポート
- [ ] 多言語対応（英語、中国語など）
- [ ] レストラン情報の保存機能
- [ ] スキャン履歴の管理
- [ ] カスタムアレルギーキーワードの追加

## ライセンス

このプロジェクトはプライベートプロジェクトです。

## 開発者

Created for Hackathon Project
